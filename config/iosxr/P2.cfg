group GR-LSP
 interface 'tunnel-te.*'
  ipv4 unnumbered Loopback0
  record-route
  path-option 1 dynamic
 !
end-group
!
group GR-ISIS
 router isis '.*'
  interface 'GigabitEthernet.*'
   point-to-point
   address-family ipv4 unicast
    fast-reroute per-prefix
   mpls ldp sync
 !
end-group
!
route-policy ISIS_LEAK
   if destination in (172.16.0.0/22 eq 32) then
     pass
   endif
end-policy
!
route-policy PL-iBGP-RR-OUT
   set next-hop self
end-policy
!
route-policy PL-eBGP-CE1-IN
  pass
end-policy
!
route-policy PL-eBGP-CE1-OUT
  set med 100
  pass
end-policy
!
route-policy BGP-PIC-EDGE-UNIPATH
  set path-selection backup 1 install
end-policy
!
router isis 65000
apply-group GR-ISIS
 net 49.0001.0000.0000.0002.00
 net 49.0000.0000.0000.0002.00
 is-type level-1-2
 set-overload-bit on-startup wait-for-bgp
 address-family ipv4 unicast
  metric-style wide
  ispf
  mpls traffic-eng level-1-2
  mpls traffic-eng router-id Loopback0
  propagate level 2 into level 1 route-policy ISIS_LEAK
interface Loopback0
  passive
  address-family ipv4 unicast
  circuit-type level-1-2
interface Loopback1
  passive
  address-family ipv4 unicast
  circuit-type level-1-2
interface Loopback2
  passive
  address-family ipv4 unicast
  circuit-type level-1-2
 interface Gi0/0/0/0.12
   circuit-type level-1-2
  address-family ipv4 unicast
   metric 10
 interface Gi0/0/0/0.222
   circuit-type level-1
  address-family ipv4 unicast
   metric 10
 interface Gi0/0/0/0.23
   circuit-type level-2-only
  address-family ipv4 unicast
   metric 10
 interface Gi0/0/0/0.24
   circuit-type level-2-only
  address-family ipv4 unicast
   metric 10
!
ipv4 access-list AL-LOCAL-PLANE-B-C
10 permit ipv4 172.16.1.0 0.0.0.255 any
20 permit ipv4 172.16.2.0 0.0.0.255 any
30 deny ipv4 any any
!
mpls ldp
 session protection
  address-family ipv4
    label
       local
          allocate for AL-LOCAL-PLANE-B-C
 interface Gi0/0/0/0.12
  address-family ipv4
 interface Gi0/0/0/0.222
  address-family ipv4
 interface Gi0/0/0/0.23
  address-family ipv4
 interface Gi0/0/0/0.24
  address-family ipv4
 no interface tunnel-te1
 interface tunnel-te21
  address-family ipv4
 no interface tunnel-te5
 interface tunnel-te25
  address-family ipv4
 no interface tunnel-te6
 interface tunnel-te26
  address-family ipv4
!
interface tunnel-te1
 apply-group GR-LSP
 signalled-name P2-->P1_PL_A
 path-selection metric te
 destination 172.16.0.1
 autoroute destination 172.16.0.11
interface tunnel-te21
 apply-group GR-LSP
 signalled-name P2-->P1_PL_C
 path-selection metric igp
 destination 172.16.0.1
 autoroute destination 172.16.2.11
 affinity include AG10
 affinity exclude AG20
 fast-reroute
interface tunnel-te5
 apply-group GR-LSP
 signalled-name P2-->P5_PL_A
 path-selection metric te
 destination 172.16.0.5
 autoroute destination 172.16.0.44
 autoroute destination 172.16.0.33
interface tunnel-te25
 apply-group GR-LSP
 signalled-name P2-->P5_PL_C
 path-selection metric igp
 destination 172.16.0.5
 autoroute destination 172.16.2.33
 autoroute destination 172.16.2.44
 affinity include AG10
 affinity exclude AG20
interface tunnel-te6
 apply-group GR-LSP
 signalled-name P2-->P6_PL_A
 path-selection metric te
 destination 172.16.0.6
 autoroute destination 172.16.0.44
 autoroute destination 172.16.0.33
interface tunnel-te26
 apply-group GR-LSP
 signalled-name P2-->P6_PL_C
 path-selection metric igp
 destination 172.16.0.6
 autoroute destination 172.16.2.33
 autoroute destination 172.16.2.44
 affinity include AG10
 affinity exclude AG20
!
rsvp
 interface Gi0/0/0/0.12
 interface Gi0/0/0/0.23
 interface Gi0/0/0/0.24
!
mpls traffic-eng
reoptimize 30
reoptimize timers delay installation 15
 interface Gi0/0/0/0.12
 admin-weight 20
 attribute-names AG10
  auto-tunnel backup
   attribute-set PLANE_C
  !
 no interface Gi0/0/0/0.222
 interface Gi0/0/0/0.23
 admin-weight 10
 attribute-names AG20
 interface Gi0/0/0/0.24
 admin-weight 100
 attribute-names AG10
 affinity-map AG10 bit-position 10
 affinity-map AG20 bit-position 20
 attribute-set auto-backup PLANE_C
  affinity include AG10
  affinity exclude AG20
  exit
!
 auto-tunnel backup
  tunnel-id min 101 max 199
  exit
!
router bgp 65000
bgp router-id 172.16.0.2
 address-family ipv4 unicast
  additional-path receive
  additional-path send
!
 neighbor-group RR
  remote-as 65000
  update-source Loopback0
  address-family ipv4 unicast
   route-policy PL-iBGP-RR-OUT out
 neighbor 172.16.0.3
 use neighbor-group RR
 neighbor 172.16.0.4
 use neighbor-group RR
!!
hostname P2
domain name croclab.ru
ipv4 unnumbered mpls traffic-eng Loopback0
!
interface Loopback0
 ipv4 address 172.16.0.2/32
interface Loopback2
 ipv4 address 172.16.2.2/32
interface Loopback1
 ipv4 address 172.16.1.2/32
!
interface MgmtEth0/0/CPU0/0
 description "OOB to MGMT Network"
 ipv4 address 172.23.84.202 255.255.255.0
 no shutdown
!
interface Gi0/0/0/0.23
 description "P3"
 encapsulation dot1q 23
 ipv4 address 10.0.0.25/31
interface Gi0/0/0/0
 no shutdown
interface Gi0/0/0/0.222
 description "PE2"
 encapsulation dot1q 222
 ipv4 address 10.0.0.18/31
interface Gi0/0/0/0
 no shutdown
interface Gi0/0/0/0.12
 description "P1"
 encapsulation dot1q 12
 ipv4 address 10.0.0.21/31
interface Gi0/0/0/0
 no shutdown
interface Gi0/0/0/0.24
 description "P4"
 encapsulation dot1q 24
 ipv4 address 10.0.0.17/31
interface Gi0/0/0/0
 no shutdown
!
router static
 address-family ipv4 unicast
  0.0.0.0/0 172.23.84.1
 !
!
mpls oam
ssh server v2
ssh server logging
xml agent ssl
 iteration off
!
xml agent tty
 iteration off
!
netconf agent tty
!
end
